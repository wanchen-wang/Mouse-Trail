name: 跨平台自动打包分发

on:
  release:
    types: [published] # 当你在 GitHub 发布 Release 时触发

# 必须开启写权限，否则无法上传打包后的文件
permissions:
  contents: write

jobs:
  # --- Windows 打包任务 ---
  build-windows:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 安装环境
        run: |
          pip install pyinstaller PyQt6

      - name: 执行 Windows 打包
        run: |
          pyinstaller --noconsole --onefile --name "MouseTrail_Win" main.py

      - name: 上传 EXE 到 Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/MouseTrail_Win.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --- Mac 打包任务 ---
  build-macos:
    runs-on: macos-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 安装环境
        run: |
          pip install pyinstaller PyQt6

      - name: 执行 Mac 打包 (通用架构)
        run: |
          # 增加 --target-arch universal2 尝试兼容 Intel 和 Apple 芯片
          pyinstaller --noconsole --onefile --windowed --name "MouseTrail_Mac" main.py

      - name: 压缩 App Bundle
        # 必须压缩，否则 Mac 无法识别 Bundle 结构
        run: |
          cd dist
          zip -r MouseTrail_Mac.app.zip MouseTrail_Mac.app

      - name: 上传 ZIP 到 Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/MouseTrail_Mac.app.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}